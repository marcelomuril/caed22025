<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Desempenho - Provas SAEB/CAED</title>
    <!-- Tailwind CSS para design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-6 lg:p-8">
    <main class="w-full max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 space-y-6">
        <header class="text-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Painel de Análise de Desempenho</h1>
            <p class="text-gray-500 mt-1">Resultados das avaliações SAEB/CAED - 2° Avaliação 2025</p>
        </header>

        <!-- Seção de Controle de Carregamento -->
        <div id="load-section" class="text-center py-4 border-t">
            <button id="load-data-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                Carregar e Analisar Dados
            </button>
            <div id="loading-feedback" class="mt-4 text-gray-600 hidden">
                <div id="loader" class="mx-auto"></div>
                <p id="loading-text" class="mt-2">Carregando e processando dados...</p>
            </div>
        </div>

        <!-- Seção de Filtros (inicialmente oculta) -->
        <div id="filters-section" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 border-t">
             <div>
                <label for="serie" class="block text-sm font-medium text-gray-700 mb-1">1. Selecione a Série/Ano:</label>
                <select id="serie" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </select>
            </div>
            <div>
                <label for="turma" class="block text-sm font-medium text-gray-700 mb-1">2. Selecione a Turma:</label>
                <select id="turma" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" disabled>
                </select>
            </div>
            <div>
                <label for="aluno" class="block text-sm font-medium text-gray-700 mb-1">3. Selecione o Aluno:</label>
                <select id="aluno" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" disabled>
                </select>
            </div>
        </div>

        <!-- Seção de Resultados (inicialmente oculta) -->
        <div id="resultado" class="hidden pt-6 border-t border-gray-200 space-y-6">
            <div id="info-aluno" class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-lg">
                <h2 class="text-xl sm:text-2xl font-semibold" id="nome-aluno"></h2>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div id="container-mat" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 text-center">Desempenho em Matemática</h3>
                    <p class="text-sm text-center text-gray-500 mb-2"><strong>Nível:</strong> <span id="proficiencia-mat"></span></p>
                    <div class="relative h-96 w-full"><canvas id="graficoMatematica"></canvas></div>
                </div>
                <div id="container-port" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 text-center">Desempenho em Língua Portuguesa</h3>
                     <p class="text-sm text-center text-gray-500 mb-2"><strong>Nível:</strong> <span id="proficiencia-port"></span></p>
                    <div class="relative h-96 w-full"><canvas id="graficoPortugues"></canvas></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- INÍCIO: MAPEAMENTO DE DESCRITORES SAEB ---
        const descritoresSAEB = { '9_ANO_MT': { 'H 01': 'D1: Identificar a localização/movimentação de objeto em mapas, croquis e outras representações gráficas.', 'H 02': 'D2: Identificar propriedades comuns e diferenças entre figuras bidimensionais e tridimensionais, relacionando-as com suas planificações.', 'H 03': 'D3: Identificar propriedades de triângulos pela comparação de medidas de lados e ângulos.', 'H 04': 'D4: Identificar relação entre quadriláteros por meio de suas propriedades.', 'H 05': 'D5: Reconhecer a conservação ou modificação de medidas dos lados, do perímetro, da área em ampliação e/ou redução de figuras poligonais.', 'H 06': 'D12: Resolver problema envolvendo o cálculo de perímetro de figuras planas.', 'H 07': 'D13: Resolver problema envolvendo o cálculo de área de figuras planas.', 'H 08': 'D14: Resolver problema envolvendo noções de volume.', 'H 09': 'D15: Resolver problema utilizando relações entre diferentes unidades de medida.', 'H 10': 'D16: Identificar a localização de números inteiros na reta numérica.', 'H 11': 'D17: Identificar a localização de números racionais na reta numérica.', 'H 12': 'D18: Efetuar cálculos com números inteiros, envolvendo as operações (adição, subtração, multiplicação, divisão, potenciação).', 'H 13': 'D20: Resolver problema com números racionais envolvendo as operações (adição, subtração, multiplicação, divisão, potenciação).', 'H 14': 'D21: Reconhecer as diferentes representações de um número racional.', 'H 15': 'D22: Identificar fração como representação que pode estar associada a diferentes significados.', 'H 16': 'D24: Resolver problema com porcentagem.', 'H 17': 'D27: Calcular o valor numérico de uma expressão algébrica.', 'H 18': 'D30: Resolver problema que envolva equação de segundo grau.', 'H 19': 'D35: Associar informações apresentadas em listas e/ou tabelas simples aos gráficos que as representam e vice-versa.', 'H 20': 'D36: Resolver problema envolvendo informações apresentadas em tabelas e/ou gráficos.' }, '9_ANO_LP': { 'H 01': 'D1: Localizar informações explícitas em um texto.', 'H 02': 'D3: Inferir o sentido de uma palavra ou expressão.', 'H 03': 'D4: Inferir uma informação implícita em um texto.', 'H 04': 'D6: Identificar o tema de um texto.', 'H 05': 'D12: Identificar a finalidade de textos de diferentes gêneros.', 'H 06': 'D5: Interpretar texto com auxílio de material gráfico diverso (propagandas, quadrinhos, foto etc.).', 'H 07': 'D2: Estabelecer relações entre partes de um texto, identificando repetições ou substituições que contribuem para a continuidade de um texto.', 'H 08': 'D7: Identificar a tese de um texto.', 'H 09': 'D8: Estabelecer relação entre a tese e os argumentos oferecidos para sustentá-la.', 'H 10': 'D14: Distinguir um fato da opinião relativa a esse fato.', 'H 11': 'D15: Estabelecer relações lógico-discursivas presentes no texto, marcadas por conjunções, advérbios etc.', 'H 12': 'D13: Identificar as marcas linguísticas que evidenciam o locutor e o interlocutor de um texto.', 'H 13': 'D10: Identificar o conflito gerador do enredo e os elementos que constroem a narrativa.', 'H 14': 'D11: Estabelecer relação causa/consequência entre partes e elementos do texto.', 'H 15': 'D9: Diferenciar as partes principais das secundárias em um texto.' }, '3_ANO_MT': { 'H 01': 'D1: Identificar a localização/movimentação de objeto em mapas, croquis e outras representações gráficas.', 'H 02': 'D6: Interpretar geometricamente os coeficientes da equação de uma reta.', 'H 03': 'D7: Identificar a equação de uma reta apresentada a partir de dois pontos dados ou de um ponto e sua inclinação.', 'H 04': 'D11: Resolver problema envolvendo o cálculo de perímetro de figuras planas.', 'H 05': 'D12: Resolver problema envolvendo o cálculo de área de figuras planas.', 'H 06': 'D13: Resolver problema envolvendo a área total e/ou volume de um sólido (prisma, pirâmide, cilindro, cone, esfera).', 'H 07': 'D14: Resolver problema utilizando relações entre diferentes unidades de medida.', 'H 08': 'D15: Identificar a localização de números reais na reta numérica.', 'H 09': 'D18: Reconhecer as diferentes representações de um número racional.', 'H 10': 'D19: Resolver problema com números naturais, envolvendo diferentes significados das operações.', 'H 11': 'D21: Resolver problema com números racionais que envolvam as operações.', 'H 12': 'D22: Utilizar a notação científica para fazer representações.', 'H 13': 'D23: Resolver problema com porcentagem.', 'H 14': 'D26: Identificar a expressão algébrica que expressa uma regularidade observada em sequências de números ou figuras (padrões).', 'H 15': 'D33: Identificar o gráfico que representa uma situação descrita em um texto.', 'H 16': 'D34: Resolver problema envolvendo informações apresentadas em tabelas e/ou gráficos.', 'H 17': 'D35: Associar informações apresentadas em listas e/ou tabelas simples aos gráficos que as representam e vice-versa.', 'H 18': 'D36: Resolver problema envolvendo o cálculo da média, moda ou mediana.' }, '3_ANO_LP': { 'H 01': 'D1: Localizar informações explícitas em um texto.', 'H 02': 'D3: Inferir o sentido de uma palavra ou expressão.', 'H 03': 'D4: Inferir uma informação implícita em um texto.', 'H 04': 'D6: Identificar o tema de um texto.', 'H 05': 'D12: Identificar a finalidade de textos de diferentes gêneros.', 'H 06': 'D5: Interpretar texto com auxílio de material gráfico diverso.', 'H 07': 'D2: Estabelecer relações entre partes de um texto, identificando repetições ou substituições.', 'H 08': 'D7: Identificar a tese de um texto.', 'H 09': 'D8: Estabelecer relação entre a tese e os argumentos.', 'H 10': 'D14: Distinguir um fato da opinião relativa a esse fato.', 'H 11': 'D15: Estabelecer relações lógico-discursivas presentes no texto.', 'H 12': 'D13: Identificar as marcas linguísticas que evidenciam o locutor e o interlocutor.', 'H 13': 'D10: Identificar o conflito gerador do enredo.', 'H 14': 'D11: Estabelecer relação causa/consequência entre partes do texto.', 'H 15': 'D9: Diferenciar as partes principais das secundárias em um texto.' } };
        // --- FIM: MAPEAMENTO ---
        
        let dadosDosAlunos = {}; // Objeto global para armazenar os dados processados

        document.addEventListener('DOMContentLoaded', () => {
            const loadBtn = document.getElementById('load-data-btn');
            const loadingFeedback = document.getElementById('loading-feedback');
            const loadingText = document.getElementById('loading-text');
            const filtersSection = document.getElementById('filters-section');
            const seletorSerie = document.getElementById('serie');
            const seletorTurma = document.getElementById('turma');
            const seletorAluno = document.getElementById('aluno');
            const resultadoSection = document.getElementById('resultado');
            const nomeAlunoEl = document.getElementById('nome-aluno');
            
            let graficos = { mat: null, port: null };
            
            loadBtn.addEventListener('click', async () => {
                loadBtn.disabled = true;
                loadingFeedback.classList.remove('hidden');

                const fileNames = ['9mat.csv', '9port.csv', '3mat.csv', '3port.csv'];
                try {
                    const responses = await Promise.all(fileNames.map(file => fetch(file)));
                    for (const res of responses) {
                        if (!res.ok) throw new Error(`Falha ao carregar o arquivo: ${res.url}`);
                    }
                    const texts = await Promise.all(responses.map(res => res.text()));

                    loadingText.textContent = 'Processando dados...';
                    processAllData(texts);
                    
                    loadingFeedback.classList.add('hidden');
                    loadBtn.parentElement.classList.add('hidden'); // Oculta o botão e a área de loading
                    filtersSection.classList.remove('hidden'); // Mostra os filtros

                    popularFiltroSerie();
                } catch (error) {
                    loadingText.textContent = `Erro: ${error.message}. Verifique se os arquivos CSV estão no mesmo diretório.`;
                    loadingText.classList.add('text-red-600');
                    document.getElementById('loader').classList.add('hidden');
                    loadBtn.disabled = false;
                }
            });

            function processAllData(texts) {
                const [text9mat, text9port, text3mat, text3port] = texts;
                parseCSV(text9mat, 'MT', '9º ANO');
                parseCSV(text9port, 'LP', '9º ANO');
                parseCSV(text3mat, 'MT', '3º ANO');
                parseCSV(text3port, 'LP', '3º ANO');
            }

            function parseCSV(csvText, component, serieDefault) {
                const lines = csvText.trim().split('\n');
                const header = lines[0].split(';').map(h => h.trim());
                const studentIndex = header.indexOf('Estudante');
                const turmaIndex = header.indexOf('Turma');
                const avaliadoIndex = header.indexOf('Avaliado');
                const nivelIndex = header.indexOf('Níveis de Aprendizagem');
                const habIndexes = header.map((h, i) => h.startsWith('H ') ? i : -1).filter(i => i !== -1);

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(';').map(v => v.trim());
                    if (values[avaliadoIndex] !== 'Sim') continue;
                    
                    const nome = values[studentIndex];
                    const turma = values[turmaIndex];
                    const serie = serieDefault;
                    
                    if (!dadosDosAlunos[serie]) dadosDosAlunos[serie] = {};
                    if (!dadosDosAlunos[serie][turma]) dadosDosAlunos[serie][turma] = [];
                    
                    let aluno = dadosDosAlunos[serie][turma].find(a => a.nome === nome);
                    if (!aluno) {
                        aluno = { nome: nome, matematica: null, portugues: null };
                        dadosDosAlunos[serie][turma].push(aluno);
                    }

                    const habilidades = habIndexes.map(index => {
                        const [acertos, total] = values[index].split('/').map(n => parseInt(n.trim(), 10));
                        return { id: header[index], acertos: isNaN(acertos) ? 0 : acertos, total: isNaN(total) ? 0 : total };
                    }).filter(h => h.total > 0);

                    const data = {
                        proficiencia: values[nivelIndex],
                        habilidades: habilidades
                    };

                    if (component === 'MT') {
                        aluno.matematica = data;
                    } else if (component === 'LP') {
                        aluno.portugues = data;
                    }
                }
            }
            
            function popularFiltroSerie() {
                seletorSerie.innerHTML = '<option value="">-- Selecione --</option>';
                const series = Object.keys(dadosDosAlunos).sort();
                series.forEach(serie => {
                    const option = document.createElement('option');
                    option.value = serie;
                    option.textContent = serie;
                    seletorSerie.appendChild(option);
                });
            }
            
            seletorSerie.addEventListener('change', () => {
                const serieSelecionada = seletorSerie.value;
                seletorTurma.innerHTML = '<option value="">-- Selecione --</option>';
                seletorAluno.innerHTML = '<option value="">-- Selecione --</option>';
                seletorTurma.disabled = true;
                seletorAluno.disabled = true;
                resultadoSection.classList.add('hidden');

                if (serieSelecionada) {
                    const turmas = Object.keys(dadosDosAlunos[serieSelecionada]).sort();
                    turmas.forEach(turma => {
                        const option = document.createElement('option');
                        option.value = turma;
                        option.textContent = turma;
                        seletorTurma.appendChild(option);
                    });
                    seletorTurma.disabled = false;
                }
            });

            seletorTurma.addEventListener('change', () => {
                const serieSelecionada = seletorSerie.value;
                const turmaSelecionada = seletorTurma.value;
                seletorAluno.innerHTML = '<option value="">-- Selecione --</option>';
                seletorAluno.disabled = true;
                resultadoSection.classList.add('hidden');
                
                if (turmaSelecionada) {
                    seletorAluno.disabled = false;
                    const alunosDaTurma = dadosDosAlunos[serieSelecionada][turmaSelecionada]
                        .sort((a, b) => a.nome.localeCompare(b.nome));
                    
                    alunosDaTurma.forEach((aluno, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = aluno.nome;
                        seletorAluno.appendChild(option);
                    });
                }
            });

            seletorAluno.addEventListener('change', () => {
                const serieSelecionada = seletorSerie.value;
                const turmaSelecionada = seletorTurma.value;
                const alunoIndex = seletorAluno.value;
                if (alunoIndex !== "") {
                    const aluno = dadosDosAlunos[serieSelecionada][turmaSelecionada][alunoIndex];
                    exibirResultados(aluno);
                    resultadoSection.classList.remove('hidden');
                } else {
                    resultadoSection.classList.add('hidden');
                }
            });

            function exibirResultados(aluno) {
                nomeAlunoEl.textContent = aluno.nome;
                if(graficos.mat) graficos.mat.destroy();
                if(graficos.port) graficos.port.destroy();

                const serie = seletorSerie.value.replace('º', '_').replace(' ', '_');

                ['mat', 'port'].forEach(subject => {
                    const container = document.getElementById(`container-${subject}`);
                    const data = subject === 'mat' ? aluno.matematica : aluno.portugues;
                    
                    if (data && data.habilidades.length > 0) {
                        const descritoresKey = `${serie}_${subject === 'mat' ? 'MT' : 'LP'}`;
                        const descritores = descritoresSAEB[descritoresKey];
                        const proficienciaEl = document.getElementById(`proficiencia-${subject}`);
                        const proficiencia = data.proficiencia || 'Não informado';

                        proficienciaEl.textContent = proficiencia;
                        proficienciaEl.className = 'px-2 py-1 rounded-md font-semibold text-xs inline-block';

                        switch (proficiencia) {
                            case 'Aprendizado Adequado': proficienciaEl.classList.add('bg-green-100', 'text-green-800'); break;
                            case 'Aprendizado Intermediário': proficienciaEl.classList.add('bg-yellow-100', 'text-yellow-800'); break;
                            case 'Defasagem': proficienciaEl.classList.add('bg-red-100', 'text-red-800'); break;
                            default: proficienciaEl.classList.add('bg-gray-100', 'text-gray-800'); break;
                        }

                        const ctx = document.getElementById(`grafico${subject === 'mat' ? 'Matematica' : 'Portugues'}`).getContext('2d');
                        const color = subject === 'mat' ? '54, 162, 235' : '75, 192, 192';
                        
                        graficos[subject] = criarGrafico(ctx, data.habilidades, color, descritores);
                        container.classList.remove('hidden');
                    } else {
                        container.classList.add('hidden');
                    }
                });
            }

            function criarGrafico(ctx, habilidades, colorRGB, descritores) {
                const labels = habilidades.map(h => h.id);
                const dadosAcertos = habilidades.map(h => h.acertos);
                const dadosErros = habilidades.map(h => h.total - h.acertos);

                return new Chart(ctx, {
                    type: 'bar', data: { labels: labels, datasets: [{ label: 'Acertos', data: dadosAcertos, backgroundColor: `rgba(${colorRGB}, 0.8)` }, { label: 'Erros', data: dadosErros, backgroundColor: `rgba(${colorRGB}, 0.3)` }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { footer: (tooltipItems) => { const index = tooltipItems[0].dataIndex; const habId = habilidades[index].id; return descritores[habId] || 'Descrição não encontrada.'; } } }, legend: { position: 'top' } }, scales: { x: { stacked: true, title: { display: true, text: 'Habilidades (Descritores)' } }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Número de Questões' }, ticks: { stepSize: 1 } } } }
                });
            }
        });
    </script>
</body>
</html>

